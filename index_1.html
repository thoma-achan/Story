<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Password Verification</title>
    <link rel="icon" href="img/title1.png" type="image/png">

    <!-- Link to external CSS -->
    <link href="css/style1.css" rel="stylesheet">
</head>
<body>
<div class="container">
    <h1>Password Verification</h1>
    <form id="password-form">
        <label for="username">Enter Username:</label>
        <input type="text" id="username" required>

        <label for="password">Enter Password:</label>
        <input type="password" id="password" required minlength="8">

        <button type="submit">Verify</button>
    </form>
    <p id="message"></p>

    <!-- Loading Indicator -->
    <div id="loading" style="display:none;">Loading...</div>
</div>

<!-- Firebase App and Script -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-analytics.js";
    import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBtmVd-KCtciFxTMBW2I7ciTAAqc5bL1jU",
        authDomain: "our-story-fef22.firebaseapp.com",
        projectId: "our-story-fef22",
        storageBucket: "our-story-fef22.firebasestorage.app",
        messagingSenderId: "608837980314",
        appId: "1:608837980314:web:7e7c11f3e4359ccb7e4f23",
        measurementId: "G-Z63NW2LJRZ"
    };

    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const db = getFirestore(app);

    // Event listener for password verification form
    document.getElementById('password-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;
        const message = document.getElementById('message');
        const loading = document.getElementById('loading');
        
        try {
            // Show loading indicator
            loading.style.display = 'block';

            // Fetch valid passwords from file (Not recommended for production, replace with Firebase Authentication)
            const response = await fetch('Password.txt');
            if (!response.ok) throw new Error('Could not load passwords file.');
            
            const text = await response.text();
            const validPasswords = text.split('\n').map(pw => pw.trim());

            // Hide loading indicator
            loading.style.display = 'none';

            if (validPasswords.includes(password)) {
                // Save username to Firestore
                saveData(username);
                
                // Store data in localStorage (not secure, use Firebase Auth for production)
                localStorage.setItem('authenticated', 'true');
                window.location.href = 'index_1.html';
                localStorage.setItem('username', username);
                
                // Role-based redirection
                if (username === 'ADMIN') {
                    localStorage.setItem('role', 'admin');
                } else {
                    localStorage.setItem('role', username);
                }

            } else {
                message.textContent = 'Invalid password.';
                message.style.color = 'red';
            }
        } catch (error) {
            message.textContent = 'An error occurred: ' + error.message;
            message.style.color = 'red';
            loading.style.display = 'none';  // Hide loading indicator if error occurs
        }
    });

    // Function to save data to Firestore
    function saveData(username) {
        const usersRef = collection(db, "users");
        addDoc(usersRef, { username: username })
            .then((docRef) => {
                console.log("Document written with ID: " + docRef.id);
            })
            .catch((error) => {
                console.error("Error adding document: " + error);
            });
    }
</script>

</body>
</html>
